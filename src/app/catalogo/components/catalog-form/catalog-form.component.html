<div class="catalog-form-container mat-elevation-z8">
  <mat-progress-bar mode="indeterminate" *ngIf="loading"></mat-progress-bar>
  
  <div class="header">
    <h2>{{ isEditMode ? 'Editar Artículo' : 'Nuevo Artículo' }}</h2>
    <button mat-icon-button (click)="goToCatalogo()">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <form [formGroup]="articuloForm" (ngSubmit)="submitForm()">
    <div class="form-grid">
      <div class="image-section">
        <div class="image-upload">
          <input type="file" accept="image/*" id="urlPhoto" (change)="onFileChange($event)" #fileInput>
          <div class="drop-area" (click)="fileInput.click()" (drop)="onDrop($event)" (dragover)="onDragOver($event)">
            <mat-icon class="upload-icon">cloud_upload</mat-icon>
            <p>Arrastra una imagen o haz clic</p>
            <p class="file-info">{{ imageFile?.name || 'Formatos: JPEG, PNG, WebP (max 5MB)' }}</p>
          </div>
          <div class="preview-container" *ngIf="imageUrl || imageLoading">
            <mat-progress-bar *ngIf="imageLoading" mode="indeterminate"></mat-progress-bar>
            <img *ngIf="imageUrl && !imageLoading" [src]="imageUrl" alt="Previsualización" class="preview-img">
          </div>
          <mat-error *ngIf="articuloForm.get('urlPhoto')?.invalid && !imageUrl">
            Imagen requerida
          </mat-error>
        </div>
      </div>

      <div class="form-section">
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Nombre</mat-label>
            <input matInput formControlName="nombre">
            <mat-hint align="end">{{ articuloForm.get('nombre')?.value?.length || 0 }}/100</mat-hint>
            <mat-error *ngIf="articuloForm.get('nombre')?.hasError('required')">
              Nombre es requerido
            </mat-error>
            <mat-error *ngIf="articuloForm.get('nombre')?.hasError('maxlength')">
              Máximo 100 caracteres
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Descripción</mat-label>
            <textarea matInput formControlName="descripcion" rows="2"></textarea>
            <mat-hint align="end">{{ articuloForm.get('descripcion')?.value?.length || 0 }}/500</mat-hint>
            <mat-error *ngIf="articuloForm.get('descripcion')?.hasError('required')">
              Descripción es requerida
            </mat-error>
            <mat-error *ngIf="articuloForm.get('descripcion')?.hasError('maxlength')">
              Máximo 500 caracteres
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row double">
          <mat-form-field appearance="outline">
            <mat-label>Código</mat-label>
            <input matInput formControlName="codigo">
            <mat-hint>Ej: HERR-001</mat-hint>
            <mat-error *ngIf="articuloForm.get('codigo')?.hasError('required')">
              Código es requerido
            </mat-error>
            <mat-error *ngIf="articuloForm.get('codigo')?.hasError('pattern')">
              Solo letras mayúsculas, números y guiones
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Rubro</mat-label>
            <mat-select formControlName="rubro">
              <mat-option *ngFor="let rubro of rubros" [value]="rubro">{{ rubro }}</mat-option>
            </mat-select>
            <mat-error *ngIf="articuloForm.get('rubro')?.hasError('required')">
              Rubro es requerido
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row double">
          <mat-form-field appearance="outline">
            <mat-label>Categoría</mat-label>
            <mat-select formControlName="categoria" [disabled]="!articuloForm.get('rubro')?.value">
              <mat-option *ngFor="let cat of filteredCategorias" [value]="cat">{{ cat }}</mat-option>
            </mat-select>
            <mat-error *ngIf="articuloForm.get('categoria')?.hasError('required')">
              Categoría es requerida
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Unidad</mat-label>
            <mat-select formControlName="unidad">
              <mat-option value="kg">kg</mat-option>
              <mat-option value="g">g</mat-option>
              <mat-option value="un">unidad</mat-option>
              <mat-option value="m">metro</mat-option>
              <mat-option value="l">litro</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="form-row double">
          <mat-form-field appearance="outline">
            <mat-label>Peso</mat-label>
            <input matInput type="number" formControlName="peso" step="0.01">
            <span matTextPrefix>{{ articuloForm.get('unidad')?.value }} &nbsp;</span>
            <mat-error *ngIf="articuloForm.get('peso')?.hasError('required')">
              Peso es requerido
            </mat-error>
            <mat-error *ngIf="articuloForm.get('peso')?.hasError('min')">
              El peso debe ser mayor a 0
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Precio Lista</mat-label>
            <input matInput type="number" formControlName="precioLista" step="0.01">
            <span matTextPrefix>$ &nbsp;</span>
            <mat-error *ngIf="articuloForm.get('precioLista')?.hasError('required')">
              Precio es requerido
            </mat-error>
            <mat-error *ngIf="articuloForm.get('precioLista')?.hasError('min')">
              El precio debe ser mayor a 0
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Precio Neto</mat-label>
            <input matInput type="number" formControlName="precioNeto" step="0.01">
            <span matTextPrefix>$ &nbsp;</span>
            <mat-error *ngIf="articuloForm.get('precioNeto')?.hasError('required')">
              Precio neto es requerido
            </mat-error>
            <mat-error *ngIf="articuloForm.get('precioNeto')?.hasError('min')">
              El precio debe ser mayor a 0
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Observaciones</mat-label>
            <textarea matInput formControlName="observaciones" rows="2"></textarea>
            <mat-hint align="end">{{ (articuloForm.get('observaciones')?.value || '').length }}/1000</mat-hint>
          </mat-form-field>
        </div>
      </div>
    </div>

    <div class="form-actions">
      <button mat-stroked-button type="button" (click)="goToCatalogo()">Cancelar</button>
      <button mat-raised-button color="primary" type="submit" [disabled]="articuloForm.invalid || loading">
        <mat-icon>{{ isEditMode ? 'save' : 'add' }}</mat-icon>
        {{ isEditMode ? 'Actualizar' : 'Crear Artículo' }}
      </button>
    </div>
  </form>
</div>